<section>

<h1>dotfiles 入門</h1>

<p>Date: 2020-04-15<br>
Speaker: Hiroshi Nishigami (hnishi)</p>

<p><img src="https://raw.githubusercontent.com/hnishi/slides-dotfiles/master/images/hnishi_icon.jpeg" width="10%" style="background:none; border:none; box-shadow:none;"></p>

</section>
<section>

<h2>近況</h2>

<p><a href="https://www.pfu.fujitsu.com/direct/hhkb/detail_pd-kb800bs.html">HHKB (Happy Hacking Keyboard)</a><br>
を買いました。 <img class="emoji" alt=":money_with_wings:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b8.png"></p>

<p><img src="https://www.pfu.fujitsu.com/direct/hhkb/images/detail_pd-kb800bs-1.jpg" width="50%" style="background:none; border:none; box-shadow:none;"></p>

</section>
<section>

<h2>はじめに</h2>

<p>最近（去年１２月頃⛄️）、 <a href="https://qiita.com/hnishi/items/28ad11df1dde8b0ed368">自分の dotfiles を整理した</a> ため、共有しようと思いました。<br>
（+ 3 ヶ月くらい使ってみた感想）</p>

</section>
<section>

<h2>対象</h2>

<p>ターミナル (CLI) 初学者向け。<br>
実は整理してる人少ないのではないかとおもっていたのですが、<br>
もし「そんなの当たり前」レベルの話でしたら申し訳ありません。<br>
作業効率化的な要素が強い話です。</p>

</section>
<section>

<h2>dotfiles とは</h2>

<ul>
  <li>unix-like systems における設定ファイルのこと。</li>
  <li>ファイル名がドット . から始まることに由来。</li>
</ul>

</section>
<section>

<h2>dotfiles の例</h2>

<ul>
  <li>.bash_profile</li>
  <li>.bashrc</li>
  <li>.zshrc</li>
  <li>.asdfrc</li>
  <li>.gitconfig</li>
  <li>.vimrc</li>
</ul>

</section>
<section>

<h2>Catalina からデフォルトシェルが bash 👉 zsh に変わった</h2>

<ul>
  <li>Mojave では Bash 3.2 (GNU Bash) (2007年から)</li>
  <li>なお、bash の開発は active で現在 version 5.0</li>
  <li>新しい bash のライセンスは GPLv3</li>
  <li>GPLv3 の制限が厳しい（独自ソフトでの使用禁止、特許絡みの問題）</li>
  <li>ちなみに、zsh は MIT License</li>
</ul>

<p><a href="https://thenextweb.com/dd/2019/06/04/why-does-macos-catalina-use-zsh-instead-of-bash-licensing/">https://thenextweb.com/dd/2019/06/04/why-does-macos-catalina-use-zsh-instead-of-bash-licensing/</a></p>

</section>
<section>

<h2>dotfiles が解決してくれること</h2>

<p>「環境構築で消耗していませんか？」</p>

<p>dotfilesを極めることで、どこで作業していても自分の環境を瞬時にサクっと作り出すことができる</p>

</section>
<section>

<h2><a href="https://qiita.com/yutakatay/items/c6c7584d9795799ee164#%E7%89%B9%E3%81%AB%E3%81%8A%E3%81%99%E3%81%99%E3%82%81%E3%81%AA%E4%BA%BA">特におすすめな人</a></h2>

<blockquote>
  <p>まぁつまり全エンジニアが対象だ！！！</p>
</blockquote>

<p>Ref: <a href="https://qiita.com/yutakatay/items/c6c7584d9795799ee164">ようこそdotfilesの世界へ</a></p>

</section>
<section>

<h2>管理手法が非常に多岐にわたっている</h2>

<p>ちょっと検索しただけでも、プログラマーごとに色が出過ぎている。</p>

<p><a href="https://github.com/search?q=dotfiles">github で dotfiles を探すと色んな人の設定を覗くことができます。</a></p>

</section>
<section>

<h2>たとえば</h2>

<ul>
  <li><a href="https://medium.com/toutsbrasil/how-to-manage-your-dotfiles-with-git-f7aeed8adf8b">ホームディレクトリをまるごと git で管理する方法</a></li>
  <li><a href="https://qiita.com/b4b4r07/items/b70178e021bef12cd4a2">make</a></li>
  <li><a href="https://medium.com/@webprolific/getting-started-with-dotfiles-43c3602fd789">ruby</a></li>
  <li><a href="https://pypi.org/project/dotfiles/">python</a></li>
  <li><a href="https://qiita.com/eihigh/items/015d8885f56328cafd96">Ansible</a></li>
</ul>

</section>
<section>

<h2>私の dotfiles 戦略</h2>

<ul>
  <li>最小構成のサーバーに対しても、すぐにdotfilesを展開できる</li>
  <li>Mac, Linux (主に ubuntu), Windows (mintty) に対応</li>
</ul>

</section>
<section>

<h2>方針</h2>

<ul>
  <li>できるだけシンプルな構成にする</li>
  <li>bash 依存のみ</li>
</ul>

</section>
<section>

<h2>成果物</h2>

<p><a href="https://github.com/hnishi/dotfiles">https://github.com/hnishi/dotfiles</a></p>

</section>
<section>

<h2>工夫</h2>

<p>ワンラインのコマンド一発で、ダウンロードとインストールを行えるようにしました</p>

</section>
<section>

<h2>ベース</h2>

<p><a href="https://github.com/yutakatay/dotfiles-mini">bash だけで展開できる最小構成の dotfiles レポジトリ</a> を参考にさせてもらいました。</p>

</section>
<section>

<h2>使い方</h2>

<pre><code>curl -L raw.githubusercontent.com/hnishi/dotfiles/master/scripts/download.sh | bash
</code></pre>

<p><a href="https://github.com/hnishi/dotfiles/blob/master/scripts/download.sh">code</a></p>

</section>
<section>

<h2>git がある場合</h2>

<pre><code class="language-bash">    if is_exists "git"; then
    # --recursive equals to ...
    # git submodule init
    # git submodule update
    git clone --recursive "$DOTFILES_GITHUB" "$DOTPATH"
</code></pre>

</section>
<section>

<h2>curl がある場合</h2>

<pre><code>    elif is_exists "curl" || is_exists "wget"; then
    # curl or wget
    local tarball="https://github.com/hnishi/dotfiles/archive/master.tar.gz"
    if is_exists "curl"; then
    curl -L "$tarball"
</code></pre>

</section>
<section>

<h2>wget がある場合</h2>

<pre><code class="language-bash">    elif is_exists "wget"; then
    wget -O - "$tarball"

    fi | tar xvz
    if [ ! -d dotfiles-master ]; then
    log_fail "dotfiles-master: not found"
    exit 1
    fi
    command mv -f dotfiles-master "$DOTPATH"
</code></pre>

</section>
<section>

<h2>dotfiles をインストールする仕組み</h2>

<p>レポジトリに存在する . (ドット) から始まるファイル or ディレクトリに関して、<br>
既存ファイルのバックアップを取って、ホームディレクトリにシンボリックリンクを貼る</p>

</section>
<section>

<pre><code class="language-bash">    if [[ "$HOME" != "$dotdir" ]];then
    for f in $dotdir/.??*; do
      [[ `basename $f` == ".git" ]] &amp;&amp; continue
      if [[ -L "$HOME/`basename $f`" ]];then
        command rm -f "$HOME/`basename $f`"
      fi
      if [[ -e "$HOME/`basename $f`" ]];then
        command mv --backup=numbered "$HOME/`basename $f`" "$HOME/.gdotbackup"
      fi
      command ln -snf $f $HOME
    done
</code></pre>

<p><a href="https://github.com/hnishi/dotfiles/blob/50e37693a3f12dc2ff5e6f50257bd9ce75f6eabd/scripts/install.sh#L23-L33">code</a></p>

</section>
<section>

<h3>TIPS</h3>

<p>mv の <code>--backup=numbered</code> オプションをつければ、番号を振ってバックアップしてくれます。<br>
私は最近知りました。</p>

</section>
<section>

<h2>クロスプラットフォーム対応</h2>

<pre><code class="language-bash">$ ls -a ~/.bashrc*
/Users/hnishi/.bashrc
/Users/hnishi/.bashrc_local
/Users/hnishi/.bashrc_linux
/Users/hnishi/.bashrc_mac
</code></pre>

</section>
<section>

<h2>bash 設定の読み込みの流れ</h2>

<p><img src="https://raw.githubusercontent.com/hnishi/slides-dotfiles/master/images/source_tree.png" style="background:none; border:none; box-shadow:none;"></p>

</section>
<section>

<h2>
<code>.bash_profile</code> と <code>.bashrc</code> の違い</h2>

<ul>
  <li>bashは、「ログインシェル」として起動すると~/.bash_profileを読み込む。</li>
  <li>シェルがログインシェルではない形で起動する場合は、~/.bash_profileを読み込まない。</li>
  <li>bashを対話的シェル（=スクリプト実行用ではないということ）として起動するときは、~/.bashrcを読み込む。</li>
</ul>

<p><a href="https://qiita.com/magicant/items/d3bb7ea1192e63fba850">本当に正しい .bashrc と .bash_profile の使ひ分け</a></p>

</section>
<section>

<h2>プロンプトのカスタマイズ</h2>

<ul>
  <li>あまりイケてない</li>
  <li>Gitのブランチ名、ステータスとコマンドの戻り値による色付け、実行時間、現在時刻など</li>
</ul>

<p><img src="https://raw.githubusercontent.com/hnishi/slides-dotfiles/master/images/ps1.png" style="background:none; border:none; box-shadow:none;"></p>

</section>
<section>

<h2>プロンプトのカスタマイズ</h2>

<p>bash だと PROMPT_COMMAND に関数を指定すると、プロンプト表示時に実行される。</p>

<pre><code class="language-bash">dispatch () {
  local EXIT_STATUS="$?" # 直前のコマンド実行結果のエラーコードを保存
  timer_stop # 直前のコマンドの処理時間を図るためのタイマー(関数)
  get_datetime # 現在時刻を取得する関数

  local status_color="" # exit status によって色を変える
  if [ $EXIT_STATUS != 0 ]; then
    status_color=$PALE_RED
  else
    status_color=$DARK_GREEN
  fi
  export PS1="${GREEN}${PS1_USER}${WHITE}:${PALE_BLUE}\w${CYAN}$(__git_ps1) ${status_color} [exit: \$?] ${WHITE}[last: ${timer_show}s] [${prompt_datetime}]\n\$ "
}
export PROMPT_COMMAND=dispatch
</code></pre>

<p><a href="https://github.com/hnishi/dotfiles/blob/50e37693a3f12dc2ff5e6f50257bd9ce75f6eabd/.bashrc#L131-L155">code</a></p>

</section>
<section>

<h2>結果</h2>

<p>bash + {git,curl,wget}<br>
があれば即座にインストールできます</p>

</section>
<section>

<h2>bash だけでも TCP 通信ができるらしい</h2>

<p>もしかすると、curl も使わなくてもいいのかもしれませんが、これは試してないです。</p>

<pre><code class="language-bash">exec 3&lt;&gt;/dev/tcp/www.google.com/80
echo -e "GET / HTTP/1.1\r\nhost: http://www.google.com\r\nConnection: close\r\n\r\n" &gt;&amp;3
cat &lt;&amp;3
</code></pre>

<p><a href="https://www.linuxjournal.com/content/more-using-bashs-built-devtcp-file-tcpip">https://www.linuxjournal.com/content/more-using-bashs-built-devtcp-file-tcpip</a></p>

</section>
<section>

<h2>使いやすいように template を作成しました</h2>

<p>以下にあるコードをコピーすると、レポジトリに dotfiles を配置するだけで使えます<br>
(bashのみ対応)。</p>

<p><a href="https://github.com/hnishi/dotfiles/releases/tag/minimal-template-v0">https://github.com/hnishi/dotfiles/releases/tag/minimal-template-v0</a></p>

</section>
<section>

<h2>まとめ</h2>

<ul>
  <li>dotfiles は育てていく感覚があって楽しい</li>
  <li>他の環境への設定の同期が楽</li>
  <li>docker 作業時、リモートサーバー作業時に便利</li>
  <li>ハードウェアの引っ越しに身軽になれる</li>
</ul>

</section>
<section>

<h2>References</h2>

<p>もっと高度な内容を知りたい方は、以下のリンクを参考にしてみて下さい。<br>
(個人的にわかりやすかった記事)</p>

<ul>
  <li><a href="https://qiita.com/yutakatay/items/c6c7584d9795799ee164">ようこそdotfilesの世界へ</a></li>
  <li><a href="https://qiita.com/b4b4r07/items/b70178e021bef12cd4a2">最強の dotfiles 駆動開発と GitHub で管理する運用方法</a></li>
  <li><a href="https://dotfiles.github.io/">dotfiles.github.io</a></li>
</ul>

</section>
<section>

<h1>おまけ</h1>

</section>
<section>

<h2>yash</h2>

<p>いろいろと調べていると弊社にいる magicant さんが <a href="https://yash.osdn.jp/">yash</a> なるPOSIX準拠のシェルを開発していることを知りました。<br>
あらためて ACCESS にはすごい技術者がいるものだと再認識しました。</p>

</section>
<section>

<h2>VS Code</h2>

<p>(PC ごとの path 等が設定ファイルに入ってくるので結構面倒)</p>

<p><a href="https://code.visualstudio.com/updates/v1_43#_settings-sync">Visual Studio Code が公式の設定ファイル同期ツールを発表</a><br>
(現在 preview 版のみ)</p>

<p>まだ使ったことはないですが、期待。<br>
マイクロソフトアカウントへの sign in が必要みたい。</p>

<p><a href="https://code.visualstudio.com/docs/editor/settings-sync">https://code.visualstudio.com/docs/editor/settings-sync</a></p>

</section>
<section>

<h2>おすすめの Theme</h2>

<p>簡単に、プロンプトを設定</p>

<ul>
  <li>
<a href="https://github.com/starship/starship">starship</a>
    <ul>
      <li>bash fish, zsh, powershell, Ion に対応</li>
    </ul>
  </li>
  <li>
<a href="https://github.com/romkatv/powerlevel10k">powerlevel10k</a>
    <ul>
      <li>zsh のみ対応</li>
    </ul>
  </li>
  <li>
<a href="https://github.com/sindresorhus/pure">pure</a>
    <ul>
      <li>zsh</li>
      <li>Go実装版 (クロスプラットフォーム): <a href="https://github.com/talal/mimir">mimir</a>
</li>
    </ul>
  </li>
</ul>

</section>
<section>

<h2><code>starship</code></h2>

<video src="https://starship.rs/demo.webm" width="80%"></video>

<p><a href="https://starship.rs/">https://starship.rs/</a></p>

</section>
<section>

<h2><code>powerlevel10k</code></h2>

<p><img src="https://raw.githubusercontent.com/romkatv/powerlevel10k-media/master/prompt-styles-high-contrast.png" width="70%" style="background:none; border:none; box-shadow:none;"></p>

<p><a href="https://github.com/romkatv/powerlevel10k">https://github.com/romkatv/powerlevel10k</a></p>

</section>
<section>

<h2><code>pure</code></h2>

<p><img src="https://github.com/sindresorhus/pure/raw/master/screenshot.png" width="70%" style="background:none; border:none; box-shadow:none;"></p>

<p><a href="https://github.com/sindresorhus/pure">https://github.com/sindresorhus/pure</a></p>

</section>
